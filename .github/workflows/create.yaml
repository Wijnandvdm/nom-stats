name: 'Create NomStats'

on:
  workflow_dispatch:  # Allows manual trigger from the GitHub Actions UI

jobs:
  create-resources:
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v3

      - name: 'Login to Azure using Azure CLI'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # - name: setup python
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: '3.10' # install the python version needed

      # - name: install python packages
      #   run: |
      #     python -m pip install --upgrade pip
      #     pip install -r requirements.txt

      - name: execute py script # run main.py
        run: python generate_static_website.py


      - name: 'Prepare and Deploy resources'
        run: |
          # Define variables
          resource_group="rg-nom-stats"
          location="westeurope"
          storage_account_name="nomstats"
          storage_account_sku="Standard_LRS"
          storage_account_hns_enabled="true"

          # Step 0: Delete resource group if necessary
          rg_exists=$(az group exists -n ${resource_group})
          if [[ "${rg_exists}" == "true" ]]; then
            echo "Resource group exists. Deleting..."
            az group delete -n ${resource_group} --yes
          else
            echo "Resource group does not exist. Skipping deletion."
          fi

          # Step 1: Create resource group
          az group create -n ${resource_group} -l ${location}

          # Step 2: Create Azure Storage Account
          az storage account create -n ${storage_account_name} -g ${resource_group} -l ${location}  \
              --sku ${storage_account_sku} --hns ${storage_account_hns_enabled}

          # Step 3: Turn on static website capability
          az storage blob service-properties update --account-name nomstats --static-website --404-document 404.html --index-document index.html

          # Step 4: Upload html files
          az storage blob upload-batch -s static_site -d '$web' --account-name nomstats --overwrite

      - name: 'Time to live'
        run: |
          sleep 1800

      - name: 'Delete Resources'
        run: |
          # Define variables
          resource_group="rg-containers"

          # Step 0: Delete resource group
          az group delete -n ${resource_group} --yes